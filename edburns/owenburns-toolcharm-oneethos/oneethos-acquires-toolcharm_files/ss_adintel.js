var _isoCountries = {
'AF' : 'Afghanistan',
'AX' : 'Aland Islands',
'AL' : 'Albania',
'DZ' : 'Algeria',
'AS' : 'American Samoa',
'AD' : 'Andorra',
'AO' : 'Angola',
'AI' : 'Anguilla',
'AQ' : 'Antarctica',
'AG' : 'Antigua And Barbuda',
'AR' : 'Argentina',
'AM' : 'Armenia',
'AW' : 'Aruba',
'AU' : 'Australia',
'AT' : 'Austria',
'AZ' : 'Azerbaijan',
'BS' : 'Bahamas',
'BH' : 'Bahrain',
'BD' : 'Bangladesh',
'BB' : 'Barbados',
'BY' : 'Belarus',
'BE' : 'Belgium',
'BZ' : 'Belize',
'BJ' : 'Benin',
'BM' : 'Bermuda',
'BT' : 'Bhutan',
'BO' : 'Bolivia',
'BA' : 'Bosnia And Herzegovina',
'BW' : 'Botswana',
'BV' : 'Bouvet Island',
'BR' : 'Brazil',
'IO' : 'British Indian Ocean Territory',
'BN' : 'Brunei Darussalam',
'BG' : 'Bulgaria',
'BF' : 'Burkina Faso',
'BI' : 'Burundi',
'KH' : 'Cambodia',
'CM' : 'Cameroon',
'CA' : 'Canada',
'CV' : 'Cape Verde',
'KY' : 'Cayman Islands',
'CF' : 'Central African Republic',
'TD' : 'Chad',
'CL' : 'Chile',
'CN' : 'China',
'CX' : 'Christmas Island',
'CC' : 'Cocos (Keeling) Islands',
'CO' : 'Colombia',
'KM' : 'Comoros',
'CG' : 'Congo',
'CD' : 'Congo, Democratic Republic',
'CK' : 'Cook Islands',
'CR' : 'Costa Rica',
'CI' : 'Cote D\'Ivoire',
'HR' : 'Croatia',
'CU' : 'Cuba',
'CY' : 'Cyprus',
'CZ' : 'Czech Republic',
'DK' : 'Denmark',
'DJ' : 'Djibouti',
'DM' : 'Dominica',
'DO' : 'Dominican Republic',
'EC' : 'Ecuador',
'EG' : 'Egypt',
'SV' : 'El Salvador',
'GQ' : 'Equatorial Guinea',
'ER' : 'Eritrea',
'EE' : 'Estonia',
'ET' : 'Ethiopia',
'FK' : 'Falkland Islands (Malvinas)',
'FO' : 'Faroe Islands',
'FJ' : 'Fiji',
'FI' : 'Finland',
'FR' : 'France',
'GF' : 'French Guiana',
'PF' : 'French Polynesia',
'TF' : 'French Southern Territories',
'GA' : 'Gabon',
'GM' : 'Gambia',
'GE' : 'Georgia',
'DE' : 'Germany',
'GH' : 'Ghana',
'GI' : 'Gibraltar',
'GR' : 'Greece',
'GL' : 'Greenland',
'GD' : 'Grenada',
'GP' : 'Guadeloupe',
'GU' : 'Guam',
'GT' : 'Guatemala',
'GG' : 'Guernsey',
'GN' : 'Guinea',
'GW' : 'Guinea-Bissau',
'GY' : 'Guyana',
'HT' : 'Haiti',
'HM' : 'Heard Island & Mcdonald Islands',
'VA' : 'Holy See (Vatican City State)',
'HN' : 'Honduras',
'HK' : 'Hong Kong',
'HU' : 'Hungary',
'IS' : 'Iceland',
'IN' : 'India',
'ID' : 'Indonesia',
'IR' : 'Iran, Islamic Republic Of',
'IQ' : 'Iraq',
'IE' : 'Ireland',
'IM' : 'Isle Of Man',
'IL' : 'Israel',
'IT' : 'Italy',
'JM' : 'Jamaica',
'JP' : 'Japan',
'JE' : 'Jersey',
'JO' : 'Jordan',
'KZ' : 'Kazakhstan',
'KE' : 'Kenya',
'KI' : 'Kiribati',
'KR' : 'Korea',
'KW' : 'Kuwait',
'KG' : 'Kyrgyzstan',
'LA' : 'Lao People\'s Democratic Republic',
'LV' : 'Latvia',
'LB' : 'Lebanon',
'LS' : 'Lesotho',
'LR' : 'Liberia',
'LY' : 'Libyan Arab Jamahiriya',
'LI' : 'Liechtenstein',
'LT' : 'Lithuania',
'LU' : 'Luxembourg',
'MO' : 'Macao',
'MK' : 'Macedonia',
'MG' : 'Madagascar',
'MW' : 'Malawi',
'MY' : 'Malaysia',
'MV' : 'Maldives',
'ML' : 'Mali',
'MT' : 'Malta',
'MH' : 'Marshall Islands',
'MQ' : 'Martinique',
'MR' : 'Mauritania',
'MU' : 'Mauritius',
'YT' : 'Mayotte',
'MX' : 'Mexico',
'FM' : 'Micronesia, Federated States Of',
'MD' : 'Moldova',
'MC' : 'Monaco',
'MN' : 'Mongolia',
'ME' : 'Montenegro',
'MS' : 'Montserrat',
'MA' : 'Morocco',
'MZ' : 'Mozambique',
'MM' : 'Myanmar',
'NA' : 'Namibia',
'NR' : 'Nauru',
'NP' : 'Nepal',
'NL' : 'Netherlands',
'AN' : 'Netherlands Antilles',
'NC' : 'New Caledonia',
'NZ' : 'New Zealand',
'NI' : 'Nicaragua',
'NE' : 'Niger',
'NG' : 'Nigeria',
'NU' : 'Niue',
'NF' : 'Norfolk Island',
'MP' : 'Northern Mariana Islands',
'NO' : 'Norway',
'OM' : 'Oman',
'PK' : 'Pakistan',
'PW' : 'Palau',
'PS' : 'Palestinian Territory, Occupied',
'PA' : 'Panama',
'PG' : 'Papua New Guinea',
'PY' : 'Paraguay',
'PE' : 'Peru',
'PH' : 'Philippines',
'PN' : 'Pitcairn',
'PL' : 'Poland',
'PT' : 'Portugal',
'PR' : 'Puerto Rico',
'QA' : 'Qatar',
'RE' : 'Reunion',
'RO' : 'Romania',
'RU' : 'Russian Federation',
'RW' : 'Rwanda',
'BL' : 'Saint Barthelemy',
'SH' : 'Saint Helena',
'KN' : 'Saint Kitts And Nevis',
'LC' : 'Saint Lucia',
'MF' : 'Saint Martin',
'PM' : 'Saint Pierre And Miquelon',
'VC' : 'Saint Vincent And Grenadines',
'WS' : 'Samoa',
'SM' : 'San Marino',
'ST' : 'Sao Tome And Principe',
'SA' : 'Saudi Arabia',
'SN' : 'Senegal',
'RS' : 'Serbia',
'SC' : 'Seychelles',
'SL' : 'Sierra Leone',
'SG' : 'Singapore',
'SK' : 'Slovakia',
'SI' : 'Slovenia',
'SB' : 'Solomon Islands',
'SO' : 'Somalia',
'ZA' : 'South Africa',
'GS' : 'South Georgia And Sandwich Isl.',
'ES' : 'Spain',
'LK' : 'Sri Lanka',
'SD' : 'Sudan',
'SR' : 'Suriname',
'SJ' : 'Svalbard And Jan Mayen',
'SZ' : 'Swaziland',
'SE' : 'Sweden',
'CH' : 'Switzerland',
'SY' : 'Syrian Arab Republic',
'TW' : 'Taiwan',
'TJ' : 'Tajikistan',
'TZ' : 'Tanzania',
'TH' : 'Thailand',
'TL' : 'Timor-Leste',
'TG' : 'Togo',
'TK' : 'Tokelau',
'TO' : 'Tonga',
'TT' : 'Trinidad And Tobago',
'TN' : 'Tunisia',
'TR' : 'Turkey',
'TM' : 'Turkmenistan',
'TC' : 'Turks And Caicos Islands',
'TV' : 'Tuvalu',
'UG' : 'Uganda',
'UA' : 'Ukraine',
'AE' : 'United Arab Emirates',
'GB' : 'United Kingdom',
'US' : 'United States',
'UM' : 'United States Outlying Islands',
'UY' : 'Uruguay',
'UZ' : 'Uzbekistan',
'VU' : 'Vanuatu',
'VE' : 'Venezuela',
'VN' : 'Viet Nam',
'VG' : 'Virgin Islands, British',
'VI' : 'Virgin Islands, U.S.',
'WF' : 'Wallis And Futuna',
'EH' : 'Western Sahara',
'YE' : 'Yemen',
'ZM' : 'Zambia',
'ZW' : 'Zimbabwe'
};

var _domainList = [
    "onetrusthomeloans.com"
    ];

function checkDomainList(c_domain) {
	return (_domainList.indexOf(c_domain) > 0) ? true : false;
}

function getCountryName(countryCode) {
    return (_isoCountries.hasOwnProperty(countryCode)) ? _isoCountries[countryCode] : countryCode;
}

function AdIntelGetUrlParams(c_url) {
	let v_params = {};
	let v_search = c_url.slice(c_url.indexOf('?') + 1);
	let v_definitions = v_search.split('&');

	v_definitions.forEach(function(val, key) {
        let parts = val.split('=', 2);
        v_params[parts[0]] = parts[1];
	});
	
	return v_params;
}

function AdIntelGetIP(json) {
	let loc = json.loc.split(',');
	let v_city = '';
	if(json.city !== null) {
	    v_city = json.city;
	} else if(json.region !== null) {
	    v_city = json.region;
	}

	let c_geoip = 'country=' + encodeURIComponent(getCountryName(json.country))
        		+ '&city=' + encodeURIComponent(v_city)
            	+ '&latitude=' + encodeURIComponent(loc[0])
            	+ '&longitude=' + encodeURIComponent(loc[1]);

	AdIntelSetCookie('ads__geoip', c_geoip, 1, true); // encode the value
	
	AdIntelPopulateData();
}

function AdIntelReadCookie(c_name) {
    if(navigator.cookieEnabled) {
    	let nameEQ = c_name + "=";
    	let ca = document.cookie.split(';');
    	for(let i=0; i < ca.length; i++) {
        	let c = ca[i];
        	while(c.charAt(0) == ' ') c = c.substring(1, c.length);
        	if(c.indexOf(nameEQ) === 0) {
        	    return c.substring(nameEQ.length, c.length); // value is usually encoded
        	}
    	}
    }
    else {
        return sessionStorage.getItem(c_name);
    }
	
	return null;
}

function AdIntelSetCookie(c_name, c_val, c_days, c_encode) {
    if(navigator.cookieEnabled) {
	    let c_ret = AdIntelReadCookie(c_name); // if the cookie is already set do not see it again
	    if(c_ret !== null && c_ret.length > 0) {
	        return;
	    }

    	let expires = "";
    	if(c_days) {
    		let date = new Date();
    		date.setTime(date.getTime()+(c_days*24*60*60*1000));
    		expires = "; expires=" + date.toGMTString();
    	}
	
    	if(c_encode) {
    	    c_val = encodeURIComponent(c_val);
    	}
    
    	let host = location.host;
    	if(host.split('.').length === 1) {
    		document.cookie = c_name + "=" + c_val + expires + "; path=/; SameSite=Lax"; // it is localhost or something similar
    	} else {
    		let domainParts = host.split('.');
    		domainParts.shift();
    		let domain = '.' + domainParts.join('.');
    
    		document.cookie = c_name + "=" + c_val + expires + "; path=/; SameSite=Lax; domain=" + domain;
    
    		// check if cookie was successfuly set to the given domain
    		// (otherwise it was a Top-Level Domain)
    		if(AdIntelReadCookie(c_name) === null || AdIntelReadCookie(c_name) !== c_val) {
    			domain = '.' + host; // append "." to current domain
    			document.cookie = c_name + "=" + c_val + expires + "; path=/; SameSite=Lax; domain=" + domain;
    		}
	    }
    } else {
        let c_ret = sessionStorage.getItem(c_name);
	    if(c_ret !== null && c_ret.length > 0) {
	        return;
	    }

        if(c_encode) {
            c_val = encodeURIComponent(c_val);
        }
        sessionStorage.set(c_name, c_val);
    }
}

// Helper function to get the referral url
function AdIntelGetReferralUrl() {
	return AdIntelReadCookie('ads__referral_url__c');
}

// Helper function to get the landing url
function AdIntelGetLandingUrl() {
	let v_date = new Date();
	let v_land_url = decodeURIComponent(AdIntelReadCookie('ads__landing_url__c'));
	let c_upam = 'wform=' + encodeURIComponent(location.origin + location.pathname) + '&' + AdIntelReadCookie('ads__geoip') + '&date=' + v_date.getTime();

	try {
    	let trackingId = AdIntelGetPropertyId();
    	let gobj = window[window.GoogleAnalyticsObject];
    	if(gobj) {
        	let tracker = gobj.getAll()[0];
        	let linker = new window.gaplugins.Linker(tracker);
        	if(trackingId === null) {
        	    trackingId = tracker.get('trackingId');
        	}
        	v_land_url = linker.decorate(v_land_url) + '&trackingid=' + trackingId;
    	} else {
            let clientId = AdIntelGetClientId();
            // v_land_url = v_land_url + '?' + '_ga=' + clientId + '&trackingid=' + trackingId;
        	if(v_land_url.indexOf("?") < 0) {
        		v_land_url += "?" + '_ga=' + clientId + '&trackingid=' + trackingId;
        	} else {
        		v_land_url += "&" + '_ga=' + clientId + '&trackingid=' + trackingId;
        	}
    	}
	} catch(err) {
	    console.log('google analytics error: ' + err.message);
	}

	if(v_land_url.indexOf("?") < 0) {
		v_land_url += "?" + c_upam;
	} else {
		v_land_url += "&" + c_upam;
	}

	return v_land_url;
}

// Populate the hidden AdIntel form fields and also send the data to child iframes
function AdIntelPopulateData() {
	let v_data = {};	
	v_data.referral_url = AdIntelGetReferralUrl();
	v_data.landing_url = AdIntelGetLandingUrl();
	
	AdIntelPopulateFormFields(v_data.referral_url, v_data.landing_url);

	// Communicate this information also to the child iframes
	for(let i = 0; i < window.frames.length; i++) {
		frames[i].postMessage(v_data, '*');
	}

}

// Populate the hidden AdIntel fields in the form
function AdIntelPopulateFormFields(c_ref, c_land) {
	let v_ref = c_ref;
	if(v_ref !== null) {
	    v_ref = v_ref.substring(0, 2000);
	}

	let v_land = c_land;
	if(v_land !== null) {
	    v_land = v_land.substring(0, 1000);
	}

	// query for input fields containing adintel
	let refList = document.querySelectorAll('[id*=referral_url], [name*=referral_url], [class*=referral_url]');

	for(let i = 0; i < refList.length; i++) {
		if(refList[i].nodeName != 'INPUT' && refList[i].hasChildNodes()) {
			let v_inputs = refList[i].getElementsByTagName("INPUT");
			for(let j = 0; j < v_inputs.length; j++) {
				v_inputs[j].value = v_ref;
			}
		} else { // node is an input field
			refList[i].value = v_ref;
		}
	}

	let landList = document.querySelectorAll('[id*=landing_url], [name*=landing_url], [class*=landing_url]');

	for(let i = 0; i < landList.length; i++) {
		if(landList[i].nodeName != 'INPUT' && landList[i].hasChildNodes()) {
			let v_inputs = landList[i].getElementsByTagName("INPUT");
			for(let j = 0; j < v_inputs.length; j++) {
				v_inputs[j].value = v_land;
			}
		} else { // node is an input field
			landList[i].value = v_land;
		}
	}
}

// get GA4 clientId
function AdIntelGetClientId() {
    let clientId = AdIntelReadCookie('_ga');
    if(clientId !== null) {
        clientId = 'ga-' + clientId.substring(6);
    }
    return clientId;
}

// get GA4 propertyId
function AdIntelGetPropertyId() {
    let propertyId = null;
    try {
        if(window.dataLayer) {
            for(let i = 0; i < window.dataLayer.length; i++) {
                let json = JSON.parse(JSON.stringify(window.dataLayer[i]));
                if('propertyId' in json === true) {
                    propertyId = json.propertyId;
                    break;
                }
    	    }
        }
	} catch(err) {
        console.log('window.dataLayer error: ' + err.message);
	}
	
    return propertyId;
}

// Cross browser way to listen for events
function AdIntelAddListener(element, type, callback) {
	if(element.addEventListener) {
	    element.addEventListener(type, callback);
	} else if(element.attachEvent) {
	    element.attachEvent('on' + type, callback);
	}
}

function AdIntelLoadJS(c_filename) {
	let fileref = document.createElement('script');
	fileref.setAttribute("type","application/javascript");
	fileref.setAttribute("src", c_filename);

	if(typeof fileref !== "undefined") {
		let c_head = document.getElementsByTagName("head")[0];
		if(c_head !== null) c_head.appendChild(fileref);
	}
}

// HubSpot forms message handler
function AdIntelHubSpotMessageHandler(event) {
    if(event.data.type === 'hsFormCallback' && event.data.eventName === 'onBeforeFormSubmit') {
	    AdIntelPopulateData();
    }
}

// returns true if both the urls have the same top-level domain, else returns false
function AdIntelCompareDomains(url1, url2) {
	if(url1 === null || url2 === null || url1 === undefined || url2 === undefined) {
	    return false;
	}
	let v_url1_parts = url1.split('.').reverse();
	let v_url2_parts = url2.split('.').reverse();
	let v_depth = (v_url1_parts.length === 4 || v_url2_parts.length === 4) ? 3 : 2;
	for(let i=0; i < v_depth; i++) {
		if(v_url1_parts[i] !== v_url2_parts[i]) {
		    return false;
		}
	}

	return true;
}

// create the three adintel cookies
function AdIntelSetCookies() {
	let v_land = document.location.href;
	let v_params = AdIntelGetUrlParams(v_land); // parse the url to find relevant values
	if('ads__landing_url' in v_params) {
		AdIntelSetCookie('ads__landing_url__c', v_params['ads__landing_url'], 0, false);
	} else {
		AdIntelSetCookie('ads__landing_url__c', v_land.split('#')[0], 0, true); // Remove anchor from url
	}

	if('ads__referral_url' in v_params) {
		AdIntelSetCookie('ads__referral_url__c', v_params['ads__referral_url'], 0, false);
	} else {
		let v_ref = (document.referrer != null && document.referrer.length > 0) ? document.referrer : v_land.split('#')[0];
		AdIntelSetCookie('ads__referral_url__c', v_ref, 0, true);
	}

	if('ads__geoip' in v_params) {
		AdIntelSetCookie('ads__geoip', v_params['ads__geoip'], 0, false);
	} else if(!navigator.userAgent.match(/bot|spider/i)) {
		if(AdIntelReadCookie('ads__geoip') === null) { // geo data not available
			AdIntelLoadJS('https://ipinfo.io/json?token=e4f7e58a3a0004&callback=AdIntelGetIP');
		}
	}

}

// Cross domain messaging - message event handler to get messages from the child window
function AdIntelParentMessageHandler(event) {
    console.log('Inside parent message handler');
	if(event.source !== null && event.source !== window.parent) {
		let v_data = {};
		v_data.referral_url = AdIntelGetReferralUrl();
		v_data.landing_url = AdIntelGetLandingUrl();
		event.source.postMessage(v_data, '*'); // send the data to the child window
	}
}

// function called after the document is loaded
function AdIntelInit() {
    AdIntelAddListener(window, "message", AdIntelParentMessageHandler);
	AdIntelPopulateData();
}

// initialise
AdIntelSetCookies();
AdIntelAddListener(window, "load", AdIntelInit);
AdIntelAddListener(window, "message", AdIntelHubSpotMessageHandler);

